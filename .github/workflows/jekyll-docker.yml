name: Build Debian Trixie (Stable Rootfs)

on:
  workflow_dispatch:
    inputs:
      debian_version:
        description: 'Debian Version (trixie is recommended for stability)'
        required: true
        default: 'trixie'

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ğŸ§¹ã€æ¸…ç†ç£ç›˜ã€‘ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç©ºé—´å­˜æ”¾ Rootfs å’Œé•œåƒ
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc "/usr/local/share/boost" "$AGENT_TOOLSDIRECTORY"
          docker image prune --all --force

      # ğŸ§ ã€é˜²çˆ†å†…å­˜ã€‘åˆ›å»º 8GB Swapï¼Œé˜²æ­¢å®‰è£…æ¡Œé¢ç¯å¢ƒæ—¶å†…å­˜æº¢å‡º
      - name: Create Swap Space
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      # ğŸ› ï¸ã€ç¯å¢ƒå‡†å¤‡ã€‘å®‰è£…äº¤å‰ç¼–è¯‘å’Œæ„å»ºå·¥å…·
      - name: Install QEMU & Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y debootstrap qemu-user-static binfmt-support
          # æ³¨å†Œ QEMU è§£é‡Šå™¨ï¼Œä½¿ x86 æœºå™¨èƒ½è¿è¡Œ arm64 æŒ‡ä»¤
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      # ğŸ“¥ã€ç¬¬ä¸€é˜¶æ®µã€‘ä»é•œåƒæºä¸‹è½½åŸºç¡€åŒ…
      - name: Bootstrap Stage 1 (Download)
        run: |
          sudo debootstrap --arch=arm64 --foreign --verbose \
            ${{ inputs.debian_version }} \
            rootfs \
            http://mirrors.ustc.edu.cn/debian/

      # ğŸ“¦ã€ç¬¬äºŒé˜¶æ®µã€‘åœ¨ chroot ç¯å¢ƒå†…è§£å‹åŒ…
      - name: Bootstrap Stage 2 (Unpack)
        run: |
          sudo cp /usr/bin/qemu-aarch64-static rootfs/usr/bin/
          sudo chroot rootfs /debootstrap/debootstrap --second-stage --verbose

      # ğŸ–¥ï¸ã€ç³»ç»Ÿé…ç½®ã€‘é…ç½® Root æƒé™ã€ç½‘ç»œå’Œ XFCE4 æ¡Œé¢
      - name: Configure Root & Install Desktop
        run: |
          # æŒ‚è½½å¿…è¦æ–‡ä»¶ç³»ç»Ÿ
          sudo mount -t proc /proc rootfs/proc
          sudo mount -t sysfs /sys rootfs/sys
          sudo mount -o bind /dev rootfs/dev

          sudo chroot rootfs /bin/bash -c "
            export DEBIAN_FRONTEND=noninteractive
            echo 'nameserver 114.114.114.114' > /etc/resolv.conf
            
            # æ›´æ–°æºå¹¶å®‰è£…å¸¸ç”¨å·¥å…·åŠæ¡Œé¢
            apt-get update
            apt-get install -y sudo curl wget nano net-tools xfce4 xfce4-goodies tightvncserver dbus-x11 openssh-server
            
            # è®¾ç½® Root å¯†ç 
            echo 'root:1213' | chpasswd
            
            # å…è®¸ SSH Root ç™»å½•
            sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
            
            # è¡¥å…¨ç¯å¢ƒå˜é‡
            echo 'export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' >> /root/.bashrc
            
            # é…ç½® VNC é»˜è®¤å¯åŠ¨ XFCE4
            mkdir -p /root/.vnc
            echo -e '#!/bin/sh\nstartxfce4 &' > /root/.vnc/xstartup
            chmod +x /root/.vnc/xstartup
            
            # æ¸…ç†ç¼“å­˜å‡å°‘ä½“ç§¯
            apt-get clean
            rm -rf /var/lib/apt/lists/*
          "
          
          # å¸è½½æŒ‚è½½ç‚¹ï¼Œä½¿ç”¨ -l é˜²æ­¢è®¾å¤‡å¿™æŠ¥é”™
          sudo umount -l rootfs/dev || true
          sudo umount -l rootfs/sys || true
          sudo umount -l rootfs/proc || true

      # ğŸ—œï¸ã€æ‰“åŒ…é˜¶æ®µã€‘ä½¿ç”¨ GZIP å¿«é€Ÿå‹ç¼©
      - name: Package & Compress
        run: |
          # ç§»é™¤æ—§çš„ xz å‚æ•°ï¼Œæ”¹ç”¨é«˜æ•ˆçš„ gzip
          sudo tar -czf debian-trixie-arm64.tar.gz -C rootfs .

      # ğŸ“¤ã€ä¸Šä¼ æˆå“ã€‘
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-trixie-image
          path: debian-trixie-arm64.tar.gz
