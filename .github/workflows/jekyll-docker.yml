name: Build Debian ARM64 Rootfs for Snapdragon 8 Elite

on:
  workflow_dispatch:
    inputs:
      debian_version:
        description: 'Debian Version (sid is recommended for new CPUs)'
        required: true
        default: 'sid'

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install QEMU & Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y debootstrap qemu-user-static binfmt-support xz-utils
          # 注册 QEMU 静态解释器，确保在 x86 上能跑 ARM64 命令
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Bootstrap Stage 1 (Download)
        run: |
          # 开启详细日志输出，使用国内镜像源加速
          sudo debootstrap --arch=arm64 --foreign --verbose \
            ${{ inputs.debian_version }} \
            rootfs \
            http://mirrors.ustc.edu.cn/debian/

      - name: Bootstrap Stage 2 (Unpack)
        run: |
          # 复制模拟器并执行第二阶段安装
          sudo cp /usr/bin/qemu-aarch64-static rootfs/usr/bin/
          sudo chroot rootfs /debootstrap/debootstrap --second-stage --verbose

      - name: Configure Root & Install Desktop
        run: |
          # 挂载必要的虚拟文件系统
          sudo mount -t proc /proc rootfs/proc
          sudo mount -t sysfs /sys rootfs/sys
          sudo mount -o bind /dev rootfs/dev

          sudo chroot rootfs /bin/bash -c "
            export DEBIAN_FRONTEND=noninteractive
            echo 'nameserver 114.114.114.114' > /etc/resolv.conf
            
            # 1. 更新并安装核心组件
            apt-get update
            apt-get install -y sudo xfce4 xfce4-goodies tightvncserver dbus-x11 openssh-server curl wget nano
            
            # 2. 配置 Root 用户密码为 1213
            echo 'root:1213' | chpasswd
            
            # 3. 允许 Root 通过 SSH 登录
            sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
            
            # 4. 修复环境变量，确保 root 能找到所有命令
            echo 'export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' >> /root/.bashrc
            
            # 5. 预设 VNC 启动脚本 (可选)
            mkdir -p /root/.vnc
            echo '#!/bin/sh' > /root/.vnc/xstartup
            echo 'startxfce4 &' >> /root/.vnc/xstartup
            chmod +x /root/.vnc/xstartup
            
            apt-get clean
          "
          
          # 解除挂载
          sudo umount rootfs/dev || true
          sudo umount rootfs/sys || true
          sudo umount rootfs/proc || true

      - name: Package & Compress
        run: |
          # 使用所有 CPU 核心并行压缩
          sudo tar -cI 'xz -T0' -f debian-rootfs-root.tar.xz -C rootfs .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-image
          path: debian-rootfs-root.tar.xz
