name: Build Debian Trixie (Stable Rootfs)

on:
  workflow_dispatch:
    inputs:
      debian_version:
        description: 'Debian Version (trixie is recommended for stability)'
        required: true
        # âœ… å·²æ”¹å› trixieï¼Œç¡®ä¿æœ€ç¨³çš„ä½“éªŒ
        default: 'trixie'

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ğŸ§¹ã€æ¸…ç†ç£ç›˜ã€‘é˜²æ­¢æ„å»ºè¿‡ç¨‹ä¸­ç©ºé—´ä¸è¶³
      - name: Free Disk Space
        run: |
          echo "Cleaning up disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          docker image prune --all --force

      # ğŸ§ ã€é˜²çˆ†å†…å­˜ã€‘åˆ›å»º 8GB Swap
      - name: Create Swap Space
        run: |
          export SWAP_SIZE=8G
          sudo fallocate -l $SWAP_SIZE /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "Swap enabled:"
          free -h

      - name: Install QEMU & Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y debootstrap qemu-user-static binfmt-support xz-utils
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Bootstrap Stage 1 (Download)
        run: |
          # ä½¿ç”¨ä¸­ç§‘å¤§æºä¸‹è½½ trixie
          sudo debootstrap --arch=arm64 --foreign --verbose \
            ${{ inputs.debian_version }} \
            rootfs \
            http://mirrors.ustc.edu.cn/debian/

      - name: Bootstrap Stage 2 (Unpack)
        run: |
          sudo cp /usr/bin/qemu-aarch64-static rootfs/usr/bin/
          # è¿™ä¸€æ­¥ä¼šæ¯” Sid ç¨å¾®æ…¢ä¸€ç‚¹ç‚¹ï¼Œå› ä¸º Trixie çš„åŒ…å‹ç¼©ç‡æœ‰æ—¶ä¸åŒï¼Œè€å¿ƒç­‰å¾…
          sudo chroot rootfs /debootstrap/debootstrap --second-stage --verbose

      - name: Configure Root & Install Desktop
        run: |
          sudo mount -t proc /proc rootfs/proc
          sudo mount -t sysfs /sys rootfs/sys
          sudo mount -o bind /dev rootfs/dev

          sudo chroot rootfs /bin/bash -c "
            export DEBIAN_FRONTEND=noninteractive
            echo 'nameserver 114.114.114.114' > /etc/resolv.conf
            
            # å®‰è£…æ ¸å¿ƒå·¥å…·
            apt-get update
            apt-get install -y sudo curl wget nano net-tools
            
            # å®‰è£… XFCE4 æ¡Œé¢ (Trixie çš„ XFCE ç‰ˆæœ¬éå¸¸ç¨³å®š)
            apt-get install -y xfce4 xfce4-goodies tightvncserver dbus-x11 openssh-server
            
            # é…ç½® Root å¯†ç ä¸º 1213
            echo 'root:1213' | chpasswd
            sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
            echo 'export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' >> /root/.bashrc
            
            # é¢„è®¾ VNC å¯åŠ¨
            mkdir -p /root/.vnc
            echo '#!/bin/sh' > /root/.vnc/xstartup
            echo 'startxfce4 &' >> /root/.vnc/xstartup
            chmod +x /root/.vnc/xstartup
            
            apt-get clean
            rm -rf /var/lib/apt/lists/*
          "
          
          sudo umount rootfs/dev || true
          sudo umount rootfs/sys || true
          sudo umount rootfs/proc || true

      - name: Package & Compress
        run: |
          # é™åˆ¶å†…å­˜ä½¿ç”¨ï¼Œé˜²æ­¢ç‚¸ Swap
          export XZ_OPT="-T0 -6 --memory=50%"
          sudo tar -cI 'xz' -f debian-trixie-arm64.tar.xz -C rootfs .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-trixie-image
          path: debian-trixie-arm64.tar.xz
