name: Build Debian ARM64 Rootfs (High Performance & Stable)

on:
  workflow_dispatch:
    inputs:
      debian_version:
        description: 'Debian Version (sid recommended)'
        required: true
        default: 'sid'

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ğŸ§¹ã€ä¼˜åŒ–1ã€‘æ¸…ç†åƒåœ¾æ–‡ä»¶ï¼Œè…¾å‡ºç©ºé—´ç»™ Swap å’Œæ„å»ºäº§ç‰©
      - name: Free Disk Space (Optimization)
        run: |
          echo "Cleaning up disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          # åˆ é™¤å¤šä½™çš„ Docker é•œåƒ
          docker image prune --all --force
          echo "Disk space after cleanup:"
          df -h

      # ğŸ§ ã€ä¼˜åŒ–2ã€‘åˆ›å»º 8GB Swap é˜²æ­¢å†…å­˜ä¸è¶³ (å…³é”®æ­¥éª¤)
      - name: Create Swap Space (Prevent OOM)
        run: |
          export SWAP_SIZE=8G
          echo "Creating ${SWAP_SIZE} swap file..."
          sudo fallocate -l $SWAP_SIZE /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "Swap status:"
          sudo swapon --show
          echo "Memory status:"
          free -h

      - name: Install QEMU & Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y debootstrap qemu-user-static binfmt-support xz-utils
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Bootstrap Stage 1 (Download)
        run: |
          # å¢åŠ  --verbose é¿å…æ—¥å¿—é•¿æ—¶é—´ä¸è¾“å‡ºçœ‹èµ·æ¥åƒå¡æ­»
          sudo debootstrap --arch=arm64 --foreign --verbose \
            ${{ inputs.debian_version }} \
            rootfs \
            http://mirrors.ustc.edu.cn/debian/

      - name: Bootstrap Stage 2 (Unpack)
        run: |
          sudo cp /usr/bin/qemu-aarch64-static rootfs/usr/bin/
          # è¿™é‡Œçš„ verbose å¾ˆé‡è¦ï¼Œè®©ä½ çœ‹åˆ°è§£å‹è¿›åº¦
          sudo chroot rootfs /debootstrap/debootstrap --second-stage --verbose

      - name: Configure Root & Install Desktop
        run: |
          sudo mount -t proc /proc rootfs/proc
          sudo mount -t sysfs /sys rootfs/sys
          sudo mount -o bind /dev rootfs/dev

          sudo chroot rootfs /bin/bash -c "
            export DEBIAN_FRONTEND=noninteractive
            echo 'nameserver 114.114.114.114' > /etc/resolv.conf
            
            # å®‰è£…æ ¸å¿ƒå·¥å…·
            apt-get update
            apt-get install -y sudo curl wget nano net-tools
            
            # å®‰è£…æ¡Œé¢ç¯å¢ƒ (è¿™ä¸€æ­¥æœ€è€—å†…å­˜ï¼Œç°åœ¨æœ‰ Swap å°±ä¸æ€•äº†)
            apt-get install -y xfce4 xfce4-goodies tightvncserver dbus-x11 openssh-server
            
            # é…ç½® Root å¯†ç å’Œ SSH
            echo 'root:1213' | chpasswd
            sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
            echo 'export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' >> /root/.bashrc
            
            # é¢„è®¾ VNC å¯åŠ¨è„šæœ¬
            mkdir -p /root/.vnc
            echo '#!/bin/sh' > /root/.vnc/xstartup
            echo 'startxfce4 &' >> /root/.vnc/xstartup
            chmod +x /root/.vnc/xstartup
            
            apt-get clean
            rm -rf /var/lib/apt/lists/*
          "
          
          sudo umount rootfs/dev || true
          sudo umount rootfs/sys || true
          sudo umount rootfs/proc || true

      - name: Package & Compress
        run: |
          # ä½¿ç”¨ XZ å¤šçº¿ç¨‹å‹ç¼©ï¼Œè¿™éå¸¸åƒå†…å­˜ï¼Œç°åœ¨æœ‰ 15GB+ (7Gç‰©ç†+8G Swap) è¶³å¤Ÿå®‰å…¨
          # å¢åŠ  XZ_OPT é™åˆ¶å†…å­˜ç™¾åˆ†æ¯”ï¼ŒåŒé‡ä¿é™©
          export XZ_OPT="-T0 -6 --memory=50%"
          sudo tar -cI 'xz' -f debian-rootfs-optimized.tar.xz -C rootfs .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-image-optimized
          path: debian-rootfs-optimized.tar.xz
